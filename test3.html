<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lateness Tracker</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/main.css"/>
</head>
<body>
    <form action="" class="form-inline" onsubmit="changeHour()">
        <div class="form-group" id="choose-hour">
            <label for="hourInp">Choose Hour: </label>
            <input type="number" class="form-control" id="hourInp"/>
        </div>
        <button type="submit" class="btn btn-default">Enter</button>
    </form>

    <script src="//d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script>
    <script>
        'use strict';

        var data;

        var width = 1500;
        var height = 1000;
        var vis = d3.select("body").append("svg")
                .attr("width", width).attr("height", height);

        queue().defer(d3.json, "lib/kcblock.geojson")
                .defer(d3.json, "lib/optimizedData.json")
                .await(ready);

        function ready(error, geojson, busData) {
            if (error) throw error;

            console.log(busData);
            data = busData;

            var center = d3.geo.centroid(geojson);

            var scale = 75000;
            var offset = [1149.9661625719302, 499.6246708768954];

            // new projection
            var projection = d3.geo.mercator().center(center)
                    .scale(scale).translate(offset).rotate([0,0,0]);
            var path = d3.geo.path().projection(projection);

            vis.selectAll("path").data(geojson.features).enter().append("path")
                    .attr("d", path)
                    .style("fill", function (d) {
                                //console.log(d.properties);
                                return getLate(d.properties.GEOID10, 3);
                                //return "white";
                            })
                    .style("stroke-width", "0.2")
                    .style("stroke", "grey");
        }

        function changeHour(hour) {
            vis.selectAll("path").style("fill", function (d) {
                return getLate(d.properties.GEOID10, hour);
            })
        }

        function getLate(geoID, hour) {
            //console.log(typeof(geoID));
            if (!(geoID in data)) return "#FFF";
            var delay = null;
            data[geoID].forEach(function (d) {
                if (d.hour === hour   ) {
                    var components = d.avg_delay.split(':');
                    var hours = parseInt(components[0]);
                    var minutes = parseInt(components[1]);
                    var seconds = parseInt(components[2]);
                    if (hours > 0) minutes = 60;
                    if (seconds >= 30) minutes += 1;
                    delay = minutes;
                }
            });
            if (delay === null) return "#FFF";
            else if (delay > 10) {
                return "#ff1300"
            } else if (delay > 8) {
                return "#ff4e40"
            } else if (delay > 6) {
                return "#ff7d73"
            } else if (delay > 4) {
                return "#ffba00"
            } else if (delay > 2) {
                return "#ffcb40"
            } else if (delay < 0) {
                return "#00BFFF";
            }
            return "#009900";
        }
        $("#prospects_form").submit(function(e) {
            e.preventDefault();
        });

    </script>
</body>
</html>